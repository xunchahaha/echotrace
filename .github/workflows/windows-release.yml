name: Build Windows & Release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch: {}

permissions:
  contents: write

jobs:
  windows:
    runs-on: windows-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: subosito/flutter-action@v2
        with:
          channel: stable

      - run: flutter pub get
      - run: flutter build windows --release

      - name: Package
        shell: pwsh
        run: |
          $tag = "${{ github.ref_name }}"
          $src = "build/windows/x64/runner/Release"
          $zip = "echotrace-windows-$tag.zip"
          if (!(Test-Path $src)) { dir build/windows -Recurse; throw "Build output not found: $src" }
          if (Test-Path $zip) { Remove-Item $zip -Force }
          Compress-Archive -Path "$src/*" -DestinationPath $zip -Force
          "ZIP_NAME=$zip" | Out-File -FilePath $env:GITHUB_ENV -Append

      - name: Build release body
        uses: actions/github-script@v7
        with:
          script: |
            const { execSync } = require("child_process");
            const fs = require("fs");

            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const tagName = context.ref.replace("refs/tags/", "");

            const tags = execSync("git tag --sort=-creatordate").toString().trim().split("\n").filter(Boolean);
            const idx = tags.indexOf(tagName);
            const prevTag = (idx >= 0 && idx + 1 < tags.length) ? tags[idx + 1] : null;

            let generated = "";
            try {
              const resp = await github.request("POST /repos/{owner}/{repo}/releases/generate-notes", {
                owner,
                repo,
                tag_name: tagName,
                previous_tag_name: prevTag || undefined
              });
              generated = resp.data.body || "";
            } catch (e) {
              core.warning(`generate-notes failed: ${e}`);
              generated = `## Changes\n\n`;
            }

            const headDate = execSync(`git show -s --format=%cI ${tagName}`).toString().trim();
            const baseDate = prevTag ? execSync(`git show -s --format=%cI ${prevTag}`).toString().trim() : null;

            let prsSection = "## Pull Requests\n";
            if (baseDate) {
              const q = `repo:${owner}/${repo} is:pr is:merged merged:${baseDate}..${headDate}`;
              const prResp = await github.rest.search.issuesAndPullRequests({ q, per_page: 100 });
              const prs = prResp.data.items || [];
              if (prs.length) {
                prsSection += prs.map(pr => `- ${pr.title} (#${pr.number}) ${pr.html_url}`).join("\n") + "\n";
              } else {
                prsSection += "- (none)\n";
              }
            } else {
              prsSection += "- (no previous tag)\n";
            }

            let commitsSection = "## Commits\n";
            if (prevTag) {
              const cmp = await github.request("GET /repos/{owner}/{repo}/compare/{base}...{head}", {
                owner,
                repo,
                base: prevTag,
                head: tagName
              });
              const commits = cmp.data.commits || [];
              if (commits.length) {
                commitsSection += commits.map(c => `- ${c.commit.message.split("\n")[0]} (${c.sha.substring(0,7)}) ${c.html_url}`).join("\n") + "\n";
              } else {
                commitsSection += "- (none)\n";
              }
            } else {
              const log = execSync(`git log ${tagName} --pretty=format:"- %s (%h)" -n 50`).toString().trim();
              commitsSection += (log ? log + "\n" : "- (none)\n");
            }

            const body = `${generated}\n\n---\n\n${prsSection}\n${commitsSection}`;
            fs.writeFileSync("RELEASE_NOTES.md", body);

      - name: Create release and upload asset
        uses: softprops/action-gh-release@v2
        with:
          body_path: RELEASE_NOTES.md
          files: ${{ env.ZIP_NAME }}
